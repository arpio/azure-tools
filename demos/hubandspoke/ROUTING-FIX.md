# Hub-Spoke Routing Fix: Web Subnet Load Balancer Unreachable

> Seth: This file was generated by Claude-code, so may not be 100$ accurate.  I can confirm that the LB endpoint failed for me, until I let Claude make these changes directly to my workload

## Problem

The App 1 Load Balancer public IP does not respond to HTTP requests. The LB marks all VMSS backends as unhealthy, so no traffic is forwarded.

## Root Cause

The hub module (`hub-vnet.bicep`) defines a single spoke route table with a default route that forces all internet-bound traffic (`0.0.0.0/0`) through the VPN Gateway:

```bicep
resource spokeRouteTable 'Microsoft.Network/routeTables@2023-05-01' = {
  name: '${resourcePrefix}-spoke-rt'
  ...
  properties: {
    routes: [
      {
        name: 'InternetToVpnGateway'
        properties: {
          addressPrefix: '0.0.0.0/0'
          nextHopType: 'VirtualNetworkGateway'
        }
      }
    ]
  }
}
```

This route table was applied to both the WebSubnet and the DatabaseSubnet in App 1. This causes two failures:

1. **LB health probe responses are black-holed.** Azure LB health probes originate from `168.63.129.16`. The VMSS instances receive the probes, but their responses are routed to the VPN Gateway (due to the `0.0.0.0/0` UDR) instead of back to the Azure infrastructure. With no healthy backends, the LB stops forwarding traffic entirely.

2. **Client return traffic is black-holed.** Even if health probes worked, HTTP response packets from the VMSS back to internet clients would also be forced through the VPN Gateway, which has no on-prem connection configured to forward them.

## Fix

Split the single spoke route table into two:

- **`{prefix}-spoke-rt`** (unchanged) — Forces `0.0.0.0/0` through VPN Gateway. Used by private subnets (e.g., DatabaseSubnet) that should not have direct internet access.
- **`{prefix}-spoke-public-rt`** (new) — Empty route table with no UDR overrides. Used by public-facing subnets (e.g., WebSubnet) that sit behind a load balancer and need direct internet return paths.

### Files Changed

**`script/modules/hub-vnet.bicep`**
- Added `spokePublicRouteTable` resource (empty route table for public-facing subnets)
- Added `spokePublicRouteTableId` output

**`main.bicep`**
- Passes `spokePublicRouteTableId` from hub module to app1 module

**`script/modules/app1-vnet.bicep`**
- Added `spokePublicRouteTableId` parameter
- Changed WebSubnet to use `spokePublicRouteTableId` instead of `spokeRouteTableId`
- DatabaseSubnet continues to use `spokeRouteTableId` (no change)

### Manual Steps for Existing Deployments

If the template has already been deployed, apply the fix without a full redeployment:

```bash
# Set subscription
az account set --subscription <subscription-id>

# 1. Create the new empty route table in the hub resource group
az network route-table create \
  --resource-group <prefix>-hub-rg \
  --name <prefix>-spoke-public-rt \
  --location <region>

# 2. Update WebSubnet to use the new route table
az network vnet subnet update \
  --resource-group <prefix>-app1-rg \
  --vnet-name <prefix>-app1-vnet \
  --name WebSubnet \
  --route-table /subscriptions/<subscription-id>/resourceGroups/<prefix>-hub-rg/providers/Microsoft.Network/routeTables/<prefix>-spoke-public-rt
```

The LB health probes should recover within seconds (probe interval is 5s, unhealthy threshold is 2).

## Design Consideration

The DatabaseSubnet intentionally keeps the VPN Gateway route. This ensures that the database tier has no direct internet access, which is appropriate for a backend data tier in a hub-spoke architecture. Only the web tier, which must serve and respond to internet clients through the load balancer, uses the unrestricted route table.
