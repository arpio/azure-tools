{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "11923328189060724855"
    }
  },
  "parameters": {
    "location": {
      "type": "string"
    },
    "vmAdminUsername": {
      "type": "string"
    },
    "sshPublicKey": {
      "type": "string"
    },
    "vmSku": {
      "type": "string"
    },
    "instanceCount": {
      "type": "int",
      "defaultValue": 2
    },
    "baseName": {
      "type": "string",
      "defaultValue": "app-sql"
    },
    "sqlAdminLogin": {
      "type": "string"
    },
    "sqlDbName": {
      "type": "string"
    },
    "sqlAdminPassword": {
      "type": "securestring",
      "defaultValue": "[format('Aa1!{0}', uniqueString(resourceGroup().id))]"
    }
  },
  "variables": {
    "vnetName": "vnet-app",
    "subnetName": "subnet-app",
    "nsgName": "nsg-app",
    "pipName": "pip-lb",
    "pipDomainNameLabel": "[format('pip-lb-{0}', uniqueString(resourceGroup().id))]",
    "lbName": "lb-app",
    "bepoolName": "lb-be",
    "probeName": "http-probe",
    "uniqueSuffix": "[uniqueString(subscription().id, resourceGroup().id, deployment().name)]",
    "sqlServerName": "[toLower(format('{0}-{1}', parameters('baseName'), variables('uniqueSuffix')))]",
    "kvName": "[format('kv-psswd-{0}', variables('uniqueSuffix'))]",
    "isArmVm": "[or(contains(toLower(parameters('vmSku')), '_p'), contains(toLower(parameters('vmSku')), 'ps_v2'))]",
    "ubuntuSku": "[if(variables('isArmVm'), '22_04-lts-arm64', '22_04-lts')]",
    "kvSecretUrl": "[format('https://{0}{1}/secrets/{2}', variables('kvName'), environment().suffixes.keyvaultDns, variables('sqlServerName'))]",
    "appPyContent": "\"\"\"\nFlask demo app - CRUD operations with Azure SQL Database.\nDisplays hostname and allows adding/deleting messages.\n\"\"\"\nimport os\nimport socket\nimport pyodbc\nfrom datetime import datetime\nfrom flask import Flask, request, redirect, url_for\n\napp = Flask(__name__)\n\n# SQL connection info (injected by Bicep via vm-setup.sh)\nSQL_SERVER = os.environ.get('SQL_SERVER', '')\nSQL_DATABASE = os.environ.get('SQL_DATABASE', '')\nSQL_USER = os.environ.get('SQL_USER', '')\nSQL_PASSWORD = os.environ.get('SQL_PASSWORD', '')\n\nHOSTNAME = socket.gethostname()\n\ndef get_connection():\n    \"\"\"Get a connection to the SQL database.\"\"\"\n    conn_str = (\n        f\"Driver={{ODBC Driver 18 for SQL Server}};\"\n        f\"Server={SQL_SERVER};\"\n        f\"Database={SQL_DATABASE};\"\n        f\"Uid={SQL_USER};\"\n        f\"Pwd={SQL_PASSWORD};\"\n        f\"Encrypt=yes;\"\n        f\"TrustServerCertificate=no;\"\n    )\n    return pyodbc.connect(conn_str)\n\ndef init_db():\n    \"\"\"Create the messages table if it doesn't exist.\"\"\"\n    try:\n        conn = get_connection()\n        cursor = conn.cursor()\n        cursor.execute(\"\"\"\n            IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='messages' AND xtype='U')\n            CREATE TABLE messages (\n                id INT IDENTITY(1,1) PRIMARY KEY,\n                message NVARCHAR(500) NOT NULL,\n                hostname NVARCHAR(100) NOT NULL,\n                created_at DATETIME DEFAULT GETDATE()\n            )\n        \"\"\")\n        conn.commit()\n        conn.close()\n        return True\n    except Exception as e:\n        print(f\"DB init error: {e}\")\n        return False\n\n@app.route('/')\ndef index():\n    \"\"\"Display hostname, messages list, and add form.\"\"\"\n    db_status = \"Connected\"\n    messages = []\n    error_msg = \"\"\n\n    try:\n        conn = get_connection()\n        init_db()\n        cursor = conn.cursor()\n        cursor.execute(\"SELECT id, message, hostname, created_at FROM messages ORDER BY created_at DESC\")\n        messages = cursor.fetchall()\n        conn.close()\n    except Exception as e:\n        db_status = f\"Error: {e}\"\n        error_msg = str(e)\n\n    # Build HTML response\n    html = f\"\"\"<!DOCTYPE html>\n<html>\n<head>\n    <title>Demo App - {HOSTNAME}</title>\n    <style>\n        body {{ font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }}\n        h1 {{ color: #333; }}\n        .hostname {{ background: #e7f3ff; padding: 15px; border-radius: 5px; margin-bottom: 20px; }}\n        .status {{ padding: 10px; border-radius: 5px; margin-bottom: 20px; }}\n        .status.ok {{ background: #d4edda; color: #155724; }}\n        .status.error {{ background: #f8d7da; color: #721c24; }}\n        table {{ width: 100%; border-collapse: collapse; margin: 20px 0; }}\n        th, td {{ padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }}\n        th {{ background: #f8f9fa; }}\n        form {{ margin: 20px 0; }}\n        input[type=\"text\"] {{ padding: 10px; width: 300px; border: 1px solid #ccc; border-radius: 4px; }}\n        button {{ padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }}\n        button:hover {{ background: #0056b3; }}\n        .delete-btn {{ background: #dc3545; padding: 5px 10px; font-size: 12px; }}\n        .delete-btn:hover {{ background: #c82333; }}\n    </style>\n</head>\n<body>\n    <h1>Demo App</h1>\n\n    <div class=\"hostname\">\n        <strong>Hostname:</strong> {HOSTNAME}\n    </div>\n\n    <div class=\"status {'ok' if db_status == 'Connected' else 'error'}\">\n        <strong>Database:</strong> {db_status}\n        {f'<br><small>{SQL_SERVER} / {SQL_DATABASE}</small>' if db_status == 'Connected' else ''}\n    </div>\n\n    <h2>Add Message</h2>\n    <form method=\"POST\" action=\"/add\">\n        <input type=\"text\" name=\"message\" placeholder=\"Enter a message...\" required>\n        <button type=\"submit\">Add</button>\n    </form>\n\n    <h2>Messages</h2>\n    <table>\n        <tr>\n            <th>ID</th>\n            <th>Message</th>\n            <th>From Host</th>\n            <th>Created</th>\n            <th>Action</th>\n        </tr>\n\"\"\"\n\n    if messages:\n        for msg in messages:\n            html += f\"\"\"        <tr>\n            <td>{msg[0]}</td>\n            <td>{msg[1]}</td>\n            <td>{msg[2]}</td>\n            <td>{msg[3]}</td>\n            <td>\n                <form method=\"POST\" action=\"/delete/{msg[0]}\" style=\"margin:0;\">\n                    <button type=\"submit\" class=\"delete-btn\">Delete</button>\n                </form>\n            </td>\n        </tr>\n\"\"\"\n    else:\n        html += \"\"\"        <tr><td colspan=\"5\">No messages yet. Add one above!</td></tr>\n\"\"\"\n\n    html += \"\"\"    </table>\n</body>\n</html>\"\"\"\n\n    return html\n\n@app.route('/add', methods=['POST'])\ndef add_message():\n    \"\"\"Add a new message.\"\"\"\n    message = request.form.get('message', '').strip()\n    if message:\n        try:\n            conn = get_connection()\n            cursor = conn.cursor()\n            cursor.execute(\n                \"INSERT INTO messages (message, hostname) VALUES (?, ?)\",\n                (message, HOSTNAME)\n            )\n            conn.commit()\n            conn.close()\n        except Exception as e:\n            print(f\"Add error: {e}\")\n    return redirect(url_for('index'))\n\n@app.route('/delete/<int:msg_id>', methods=['POST'])\ndef delete_message(msg_id):\n    \"\"\"Delete a message by ID.\"\"\"\n    try:\n        conn = get_connection()\n        cursor = conn.cursor()\n        cursor.execute(\"DELETE FROM messages WHERE id = ?\", (msg_id,))\n        conn.commit()\n        conn.close()\n    except Exception as e:\n        print(f\"Delete error: {e}\")\n    return redirect(url_for('index'))\n\nif __name__ == '__main__':\n    app.run(host='0.0.0.0', port=80)\n",
    "setupScriptTemplate": "#!/bin/bash\nset -euxo pipefail\nexport DEBIAN_FRONTEND=noninteractive\n\n# SQL connection info (placeholders replaced by Bicep)\nSQL_SERVER=\"{{SQL_SERVER}}\"\nSQL_DATABASE=\"{{SQL_DATABASE}}\"\nSQL_USER=\"{{SQL_USER}}\"\nSQL_PASSWORD=\"{{SQL_PASSWORD}}\"\n\n# Update and install base dependencies\napt-get update\napt-get install -y python3 python3-pip python3-venv curl gnupg\n\n# Install Microsoft ODBC driver for SQL Server\ncurl -fsSL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor -o /usr/share/keyrings/microsoft-prod.gpg\necho \"deb [arch=amd64,arm64 signed-by=/usr/share/keyrings/microsoft-prod.gpg] https://packages.microsoft.com/ubuntu/22.04/prod jammy main\" > /etc/apt/sources.list.d/mssql-release.list\napt-get update\nACCEPT_EULA=Y apt-get install -y msodbcsql18 unixodbc-dev\n\n# Create application directory\nmkdir -p /opt/demo-app\n\n# Create Python virtual environment and install dependencies\npython3 -m venv /opt/demo-app/venv\n/opt/demo-app/venv/bin/pip install --upgrade pip\n/opt/demo-app/venv/bin/pip install flask pyodbc gunicorn\n\n# Create the Flask application\ncat > /opt/demo-app/app.py << 'PYEOF'\n{{APP_PY}}\nPYEOF\n\n# Create environment file with SQL connection info\ncat > /opt/demo-app/.env << ENVEOF\nSQL_SERVER=${SQL_SERVER}\nSQL_DATABASE=${SQL_DATABASE}\nSQL_USER=${SQL_USER}\nSQL_PASSWORD=${SQL_PASSWORD}\nENVEOF\n\nchmod 600 /opt/demo-app/.env\n\n# Create systemd service\ncat > /etc/systemd/system/demo-app.service << 'SVCEOF'\n[Unit]\nDescription=Demo Flask App\nAfter=network.target\n\n[Service]\nType=simple\nUser=root\nWorkingDirectory=/opt/demo-app\nEnvironmentFile=/opt/demo-app/.env\nExecStart=/opt/demo-app/venv/bin/gunicorn --bind 0.0.0.0:80 --workers 2 --access-logfile /var/log/demo-app-access.log --error-logfile /var/log/demo-app-error.log app:app\nRestart=always\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target\nSVCEOF\n\n# Enable and start the service\nsystemctl daemon-reload\nsystemctl enable demo-app\nsystemctl start demo-app\n",
    "setupScript": "[replace(replace(replace(replace(replace(variables('setupScriptTemplate'), '{{SQL_SERVER}}', format('{0}{1}', variables('sqlServerName'), environment().suffixes.sqlServerHostname)), '{{SQL_DATABASE}}', parameters('sqlDbName')), '{{SQL_USER}}', parameters('sqlAdminLogin')), '{{SQL_PASSWORD}}', parameters('sqlAdminPassword')), '{{APP_PY}}', variables('appPyContent'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Network/networkSecurityGroups",
      "apiVersion": "2023-11-01",
      "name": "[variables('nsgName')]",
      "location": "[parameters('location')]",
      "properties": {
        "securityRules": [
          {
            "name": "allow-ssh",
            "properties": {
              "priority": 1000,
              "access": "Allow",
              "direction": "Inbound",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "22",
              "sourceAddressPrefix": "*",
              "destinationAddressPrefix": "*"
            }
          },
          {
            "name": "allow-http",
            "properties": {
              "priority": 1010,
              "access": "Allow",
              "direction": "Inbound",
              "protocol": "Tcp",
              "sourcePortRange": "*",
              "destinationPortRange": "80",
              "sourceAddressPrefix": "*",
              "destinationAddressPrefix": "*"
            }
          }
        ]
      }
    },
    {
      "type": "Microsoft.Network/virtualNetworks",
      "apiVersion": "2023-11-01",
      "name": "[variables('vnetName')]",
      "location": "[parameters('location')]",
      "properties": {
        "addressSpace": {
          "addressPrefixes": [
            "10.0.0.0/16"
          ]
        },
        "subnets": [
          {
            "name": "[variables('subnetName')]",
            "properties": {
              "addressPrefix": "10.0.0.0/24",
              "networkSecurityGroup": {
                "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
              }
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
      ]
    },
    {
      "type": "Microsoft.Network/publicIPAddresses",
      "apiVersion": "2023-11-01",
      "name": "[variables('pipName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "Standard"
      },
      "properties": {
        "publicIPAllocationMethod": "Static",
        "dnsSettings": {
          "domainNameLabel": "[variables('pipDomainNameLabel')]"
        }
      }
    },
    {
      "type": "Microsoft.Network/loadBalancers",
      "apiVersion": "2023-11-01",
      "name": "[variables('lbName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "Standard"
      },
      "properties": {
        "frontendIPConfigurations": [
          {
            "name": "fe-ip",
            "properties": {
              "publicIPAddress": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('pipName'))]"
              }
            }
          }
        ],
        "backendAddressPools": [
          {
            "name": "[variables('bepoolName')]"
          }
        ],
        "probes": [
          {
            "name": "[variables('probeName')]",
            "properties": {
              "protocol": "Tcp",
              "port": 80,
              "intervalInSeconds": 5,
              "numberOfProbes": 2
            }
          }
        ],
        "loadBalancingRules": [
          {
            "name": "http-rule",
            "properties": {
              "frontendIPConfiguration": {
                "id": "[resourceId('Microsoft.Network/loadBalancers/frontendIPConfigurations', variables('lbName'), 'fe-ip')]"
              },
              "backendAddressPool": {
                "id": "[resourceId('Microsoft.Network/loadBalancers/backendAddressPools', variables('lbName'), variables('bepoolName'))]"
              },
              "probe": {
                "id": "[resourceId('Microsoft.Network/loadBalancers/probes', variables('lbName'), variables('probeName'))]"
              },
              "protocol": "Tcp",
              "frontendPort": 80,
              "backendPort": 80,
              "idleTimeoutInMinutes": 4,
              "enableFloatingIP": false,
              "loadDistribution": "Default"
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/publicIPAddresses', variables('pipName'))]"
      ]
    },
    {
      "type": "Microsoft.Compute/virtualMachineScaleSets",
      "apiVersion": "2023-09-01",
      "name": "vmss-app",
      "location": "[parameters('location')]",
      "sku": {
        "name": "[parameters('vmSku')]",
        "tier": "Standard",
        "capacity": "[parameters('instanceCount')]"
      },
      "properties": {
        "upgradePolicy": {
          "mode": "Rolling"
        },
        "virtualMachineProfile": {
          "storageProfile": {
            "imageReference": {
              "publisher": "Canonical",
              "offer": "0001-com-ubuntu-server-jammy",
              "sku": "[variables('ubuntuSku')]",
              "version": "latest"
            },
            "osDisk": {
              "createOption": "FromImage",
              "managedDisk": {
                "storageAccountType": "Standard_LRS"
              }
            }
          },
          "osProfile": {
            "computerNamePrefix": "vmss",
            "adminUsername": "[parameters('vmAdminUsername')]",
            "linuxConfiguration": {
              "disablePasswordAuthentication": true,
              "ssh": {
                "publicKeys": [
                  {
                    "path": "[format('/home/{0}/.ssh/authorized_keys', parameters('vmAdminUsername'))]",
                    "keyData": "[parameters('sshPublicKey')]"
                  }
                ]
              }
            },
            "customData": "[base64(variables('setupScript'))]"
          },
          "networkProfile": {
            "networkInterfaceConfigurations": [
              {
                "name": "nicconfig1",
                "properties": {
                  "primary": true,
                  "ipConfigurations": [
                    {
                      "name": "ipconfig1",
                      "properties": {
                        "subnet": {
                          "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), variables('subnetName'))]"
                        },
                        "loadBalancerBackendAddressPools": [
                          {
                            "id": "[resourceId('Microsoft.Network/loadBalancers/backendAddressPools', variables('lbName'), variables('bepoolName'))]"
                          }
                        ]
                      }
                    }
                  ]
                }
              }
            ],
            "healthProbe": {
              "id": "[resourceId('Microsoft.Network/loadBalancers/probes', variables('lbName'), variables('probeName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/loadBalancers', variables('lbName'))]"
      ]
    },
    {
      "type": "Microsoft.Insights/autoscalesettings",
      "apiVersion": "2022-10-01",
      "name": "autoscale-vmss",
      "location": "[parameters('location')]",
      "properties": {
        "enabled": true,
        "name": "autoscale-vmss",
        "targetResourceUri": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', 'vmss-app')]",
        "profiles": [
          {
            "name": "default",
            "capacity": {
              "minimum": "2",
              "maximum": "4",
              "default": "2"
            },
            "rules": [
              {
                "metricTrigger": {
                  "metricName": "Percentage CPU",
                  "metricNamespace": "",
                  "metricResourceUri": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', 'vmss-app')]",
                  "timeGrain": "PT1M",
                  "statistic": "Average",
                  "timeWindow": "PT10M",
                  "timeAggregation": "Average",
                  "operator": "GreaterThan",
                  "threshold": 70
                },
                "scaleAction": {
                  "direction": "Increase",
                  "type": "ChangeCount",
                  "value": "1",
                  "cooldown": "PT5M"
                }
              },
              {
                "metricTrigger": {
                  "metricName": "Percentage CPU",
                  "metricNamespace": "",
                  "metricResourceUri": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', 'vmss-app')]",
                  "timeGrain": "PT1M",
                  "statistic": "Average",
                  "timeWindow": "PT10M",
                  "timeAggregation": "Average",
                  "operator": "LessThan",
                  "threshold": 30
                },
                "scaleAction": {
                  "direction": "Decrease",
                  "type": "ChangeCount",
                  "value": "1",
                  "cooldown": "PT5M"
                }
              }
            ]
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachineScaleSets', 'vmss-app')]"
      ]
    },
    {
      "type": "Microsoft.Network/networkInterfaces",
      "apiVersion": "2023-11-01",
      "name": "nic-standalone",
      "location": "[parameters('location')]",
      "properties": {
        "ipConfigurations": [
          {
            "name": "ipconfig1",
            "properties": {
              "subnet": {
                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), variables('subnetName'))]"
              },
              "loadBalancerBackendAddressPools": [
                {
                  "id": "[resourceId('Microsoft.Network/loadBalancers/backendAddressPools', variables('lbName'), variables('bepoolName'))]"
                }
              ]
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/loadBalancers', variables('lbName'))]",
        "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
      ]
    },
    {
      "type": "Microsoft.Compute/virtualMachines",
      "apiVersion": "2023-09-01",
      "name": "vm-standalone",
      "location": "[parameters('location')]",
      "properties": {
        "hardwareProfile": {
          "vmSize": "[parameters('vmSku')]"
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "Canonical",
            "offer": "0001-com-ubuntu-server-jammy",
            "sku": "[variables('ubuntuSku')]",
            "version": "latest"
          },
          "osDisk": {
            "createOption": "FromImage",
            "managedDisk": {
              "storageAccountType": "Standard_LRS"
            }
          }
        },
        "osProfile": {
          "computerName": "vm-standalone",
          "adminUsername": "[parameters('vmAdminUsername')]",
          "linuxConfiguration": {
            "disablePasswordAuthentication": true,
            "ssh": {
              "publicKeys": [
                {
                  "path": "[format('/home/{0}/.ssh/authorized_keys', parameters('vmAdminUsername'))]",
                  "keyData": "[parameters('sshPublicKey')]"
                }
              ]
            }
          },
          "customData": "[base64(variables('setupScript'))]"
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces', 'nic-standalone')]",
              "properties": {
                "primary": true
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkInterfaces', 'nic-standalone')]"
      ]
    },
    {
      "type": "Microsoft.KeyVault/vaults",
      "apiVersion": "2025-05-01",
      "name": "[variables('kvName')]",
      "location": "[parameters('location')]",
      "properties": {
        "sku": {
          "name": "standard",
          "family": "A"
        },
        "tenantId": "[subscription().tenantId]",
        "enableRbacAuthorization": true,
        "accessPolicies": null,
        "enabledForDeployment": false,
        "enabledForTemplateDeployment": true
      }
    },
    {
      "type": "Microsoft.KeyVault/vaults/secrets",
      "apiVersion": "2025-05-01",
      "name": "[format('{0}/{1}', variables('kvName'), variables('sqlServerName'))]",
      "properties": {
        "value": "[parameters('sqlAdminPassword')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', variables('kvName'))]"
      ]
    },
    {
      "type": "Microsoft.Sql/servers",
      "apiVersion": "2023-08-01",
      "name": "[variables('sqlServerName')]",
      "location": "[parameters('location')]",
      "properties": {
        "administratorLogin": "[parameters('sqlAdminLogin')]",
        "administratorLoginPassword": "[parameters('sqlAdminPassword')]",
        "publicNetworkAccess": "Enabled",
        "version": "12.0"
      },
      "tags": {
        "arpio-config:admin-password-secret": "[variables('kvSecretUrl')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', variables('kvName'))]"
      ]
    },
    {
      "type": "Microsoft.Sql/servers/firewallRules",
      "apiVersion": "2023-08-01",
      "name": "[format('{0}/{1}', variables('sqlServerName'), 'AllowAllAzureServices')]",
      "properties": {
        "startIpAddress": "0.0.0.0",
        "endIpAddress": "0.0.0.0"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Sql/servers', variables('sqlServerName'))]"
      ]
    },
    {
      "type": "Microsoft.Sql/servers/firewallRules",
      "apiVersion": "2023-08-01",
      "name": "[format('{0}/{1}', variables('sqlServerName'), 'AllowAllIP')]",
      "properties": {
        "startIpAddress": "0.0.0.0",
        "endIpAddress": "255.255.255.255"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Sql/servers', variables('sqlServerName'))]"
      ]
    },
    {
      "type": "Microsoft.Sql/servers/databases",
      "apiVersion": "2023-08-01",
      "name": "[format('{0}/{1}', variables('sqlServerName'), parameters('sqlDbName'))]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "GP_Gen5_2",
        "tier": "GeneralPurpose",
        "capacity": 2
      },
      "properties": {
        "collation": "SQL_Latin1_General_CP1_CI_AS",
        "maxSizeBytes": 268435456000
      },
      "dependsOn": [
        "[resourceId('Microsoft.Sql/servers', variables('sqlServerName'))]"
      ]
    }
  ],
  "outputs": {
    "loadBalancerPublicIP": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('pipName')), '2023-11-01').ipAddress]"
    },
    "loadBalancerFQDN": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('pipName')), '2023-11-01').dnsSettings.fqdn]"
    },
    "sqlServerFqdn": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Sql/servers', variables('sqlServerName')), '2023-08-01').fullyQualifiedDomainName]"
    },
    "sqlAdminPwdSecretUrl": {
      "type": "string",
      "value": "[variables('kvSecretUrl')]"
    }
  }
}